name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'The number of the pull request to review'
        required: true

permissions:
  pull-requests: write
  actions: read
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate with GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: Determine PR Number
        id: pr_number
        run: |
          if [ -n "${{ github.event.inputs.pull_request_number }}" ]; then
            echo "pr_number=${{ github.event.inputs.pull_request_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Context Packet
        id: context_packet
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PAGER: ""
        run: |
          # Get the diff
          DIFF=$(gh pr diff ${{ steps.pr_number.outputs.pr_number }})

          # Get the list of changed files
          CHANGED_FILES=$(gh pr diff ${{ steps.pr_number.outputs.pr_number }} --name-only)

          # Create the context packet
          CONTEXT_PACKET="
          ## Pull Request Diff:
          ```diff
          ${DIFF}
          ```

          ## Full Content of Changed Files:
          "

          for file in ${CHANGED_FILES}; do
            CONTEXT_PACKET="${CONTEXT_PACKET}
            ---
            ### File: ${file}
            ```
            $(cat ${file})
            ```
            "
          done

          echo "context<<EOF" >> $GITHUB_OUTPUT
          echo "${CONTEXT_PACKET}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: DEBUG - Show Context Packet
        run: echo "${{ steps.context_packet.outputs.context }}"

      - name: Create Review Prompt
        id: create_prompt
        env:
          REVIEW_PROMPT: |
            You are an expert code reviewer. Your task is to provide a detailed review of this pull request.

            **IMPORTANT:** You have been provided with a complete "context packet" that includes both the pull request diff and the full content of every changed file. Rely *only* on this context to perform your review.

            **Review Guidelines:**
            - Focus on code quality, security, performance, and maintainability.
            - For this project, also consider the gameplay and user experience.
            - Provide specific, constructive feedback.

            **Output Format:**
            Please structure your feedback using this exact markdown format. If you have no feedback for a section, omit it.

            ---
            ### ðŸŽ® Gameplay & UX
            *(Feedback on the user experience, game feel, and fun factor.)*

            ### ðŸ’¡ Suggestions
            *(Specific suggestions for improvement, including code snippets if helpful.)*
            - **File:** `path/to/file.js:line` - Your detailed suggestion.

            ### âœ¨ Highlights
            *(Point out things you liked about the PR!)*

            ---

            If you have no suggestions at all, respond with the single phrase: "This looks great! No suggestions."

            Here is the context packet:
        run: |
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "${REVIEW_PROMPT}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Gemini CLI for Review
        id: gemini_review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Create the .gemini directory
          mkdir -p .gemini

          # Temporarily create the settings file to disable telemetry
          echo '{
            "telemetry": {"enabled": false}
          }' > .gemini/settings.json

          npm install -g @google/gemini-cli
          
          # Pipe the context and prompt to the gemini command
          printf "%s\n\n%s" "${{ steps.create_prompt.outputs.prompt }}" "${{ steps.context_packet.outputs.context }}" | gemini > review.md

      - name: Upload Review Artifact
        uses: actions/upload-artifact@v4
        with:
          name: review
          path: review.md

      - name: Post Review Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! grep -q "This looks great! No suggestions." review.md; then
            gh pr comment ${{ steps.pr_number.outputs.pr_number }} --body-file review.md
          fi